name: Nginx CI/CD

on:
  push:
    branches: [ "main", "dev", "feature/**" ]
    paths:
      - 'nginx/**'
      - 'docker-compose.yml'
      - '.github/workflows/ci-nginx.yml'
  pull_request: 
    branches: [ "main", "dev" ]
    paths:
      - 'nginx/**'
      - 'docker-compose.yml'
      - '.github/workflows/ci-nginx.yml'
 
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Copy Nginx Config & Docker Compose
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST_VM }}
          username: ${{ secrets.SSH_USER_VM }}
          key: ${{ secrets.SSH_KEY_VM }}
          port: ${{ secrets.SSH_PORT || 22 }}
          source: "nginx,docker-compose.yml"
          target: "~/app"

      - name: Deploy Nginx
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST_VM }}
          username: ${{ secrets.SSH_USER_VM }}
          key: ${{ secrets.SSH_KEY_VM }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            cd ~/app
            
            # 0. 필수 파일 확인 (없으면 생성 - Docker Compose 파싱 오류 방지)
            if [ ! -f .env ]; then touch .env; fi
            mkdir -p backend
            if [ ! -f backend/.env ]; then touch backend/.env; fi
            
            # --- Nginx 설정 자동화 (IP 치환) ---
            # GPU Server IP 치환 (모니터링 연결용)
            if [ -f nginx/conf.d/default.conf ]; then
              sed -i "s/GPU_SERVER_IP_PLACEHOLDER/${{ secrets.SSH_HOST_GPU }}/g" nginx/conf.d/default.conf
              echo "Nginx config updated with GPU Server IP."
            fi
            
            # Docker Hub 로그인 (이미지 pull을 위해)
            echo ${{ secrets.DOCKER_TOKEN }} | sudo docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
            
            # Nginx 컨테이너 실행 (설정 변경 반영)
            # backend, frontend 의존성 무시하고 Nginx만 단독 실행 (--no-deps)
            # backend/.env 내용이 비어있어도 Nginx는 상관없으므로 안전함
            sudo docker compose up -d nginx --no-deps --remove-orphans
            
            # 확실한 적용을 위해 강제 재시작
            sudo docker compose restart nginx
            
            # Cleanup
            sudo docker image prune -af --filter "until=10m" || true
